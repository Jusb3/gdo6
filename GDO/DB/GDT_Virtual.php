<?php
namespace GDO\DB;

use GDO\Core\GDT;
use GDO\UI\WithLabel;

/**
 * A virtual field that is generated by a subquery.
 * Uses a proxy gdt to render.
 * 
 * You need to provide subquery sql and gdt proxy
 * 
 * @author gizmore
 * @version 6.10
 * @since 6.10
 * 
 * @see GDT_Join
 */
class GDT_Virtual extends GDT
{
    use WithLabel;
    use WithDatabase;
    
    protected function __construct()
    {
        parent::__construct();
        $this->virtual = true;
    }
    
    #############
    ### Query ###
    #############
    public $subquery;
    public function subquery($subquery) { $this->subquery = $subquery; return $this; }
    
    #############
    ### Event ###
    #############
    /**
     * Select this virtual column as subselect.
     */
    public function gdoBeforeRead(Query $query)
    {
        if ($this->subquery)
        {
            $query->select("({$this->subquery}) {$this->name}");
        }
    }
    
    public function getGDOData() {} # virtual => no data
    
    #############
    ### Proxy ###
    #############
    /** @var $gdtType GDT **/
    public $gdtType;
    private function proxy() { return $this->gdtType->gdo($this->gdo)->label($this->label, $this->labelArgs); }
    public function gdtType($gdt) { $this->gdtType = $gdt; $this->gdtType->name = $this->name; return $this; }
    
    ##############
    ### Render ###
    ##############
    public function htmlClass() { return $this->gdtType->htmlClass(); }

    public function renderHeader() { return $this->proxy()->renderHeader(); }
    public function render() { return $this->proxy()->render(); }
    public function renderCell() { return $this->proxy()->renderCell(); }
    public function renderCard() { return $this->proxy()->renderCard(); }
    public function renderForm() { return $this->proxy()->renderForm(); }
}
